# Project Coding Rules (Non-Obvious Only)

- **Buffer Global Setup**: Must set `window.Buffer = Buffer` globally before using `music-metadata-browser` (see `src/services/metadataExtractor.ts:48-50`)
- **Service Layer Mandatory**: Never query Supabase directly in components - always use `src/services/*.service.ts` files
- **Supabase Client Import**: Always `import { supabase } from '@/integrations/supabase/client'` - never use env vars directly
- **Pagination Critical**: Supabase silently truncates at 1000 rows - use `.range()` or `.limit()` for large datasets
- **SUPER_GENRES Sorting**: UI must use `[...SUPER_GENRES].sort()` - the array itself is intentionally unsorted
- **Edge Function Isolation**: Cannot import from `src/` in edge functions - must duplicate shared code
- **Metadata Validation**: All extracted metadata must pass Zod schema validation before database insertion
- **Batch Size Limits**: File processing batches limited to 5 files, Spotify API to 50 items per request
- **Auth Context Consolidation**: Only `NewAuthProvider` exists - legacy `AuthContext` removed to prevent conflicts and race conditions
- **Auth Context Deferred Loading**: User data loading must be deferred with `setTimeout` to prevent initialization deadlocks
- **Role Storage Security**: Roles stored in separate `user_roles` table, never on user profiles to prevent privilege escalation
- **Password Reset Implementation**: Complete flow with token validation - use `/reset-password` route, not inline forms
- **Auth Import Pattern**: Always `import { useAuth } from '@/contexts/NewAuthContext'` - no legacy auth imports allowed
- **Token Vault Storage**: Spotify tokens stored as vault secret IDs, actual token fields contain `***ENCRYPTED_IN_VAULT***` placeholders
- **Unified Spotify Auth Manager**: Must use `SpotifyAuthManager.getInstance()` singleton - never instantiate directly
- **Unified Hook Only**: Only `useUnifiedSpotifyAuth` exists - legacy hooks removed during cleanup
- **Connection Check Cooldown**: SpotifyAuthManager has 5-second cooldown - use `force: true` to bypass for immediate checks
- **State Subscription Required**: Components must subscribe to auth state changes via `subscribe()` method for real-time updates
- **Promise Deduplication**: Multiple simultaneous connection checks return same promise - prevents race conditions
- **OAuth Callback Issue**: SpotifyIntegrationCallback flow never completes properly - needs debugging
- **Supabase Client Configuration**: Never add custom fetch wrappers with AbortController - conflicts with SDK's internal handling, use default configuration only
- **Session Cache Direct Calls**: Use direct `supabase.auth.getSession()` calls instead of timeout wrappers during critical flows to prevent cascading failures
- **Edge Function Timeout Requirements**: Cold-start edge functions need 45+ second timeouts for complex operations (auth, token exchange, vault storage, database upserts)
- **Error Type Classification**: Implement specific error types (NETWORK_TIMEOUT, SERVER_TIMEOUT, NETWORK_ERROR, SERVER_ERROR) for proper user messaging
- **Session State Preservation**: Failed operations must not trigger additional session checks that could corrupt auth state - preserve existing session
- **Promise Timeout Protection**: Use `withTimeout()` from `src/utils/promiseUtils.ts` for operations that may hang - critical for auth operations like signOut