# Project Documentation Rules (Non-Obvious Only)

- **Architecture Document**: Comprehensive technical reference at `docs/architecture-mako-sync.md` - contains critical patterns not evident from code structure
- **Acceptance Tests as Documentation**: `src/__tests__/genreMapping.acceptance.test.ts` documents business requirements, not actual tests
- **Service Layer Pattern**: All database operations abstracted through `src/services/*.service.ts` - components never query directly
- **Edge Function Isolation**: Functions in `supabase/functions/` cannot import from `src/` - self-contained with duplicated utilities
- **Genre System Complexity**: SUPER_GENRES array intentionally unsorted, UI must sort alphabetically, database enum updates require separate transactions
- **Token Security Model**: Spotify tokens stored in Supabase Vault with secret IDs, not plain text in database tables
- **File Processing Architecture**: Complex metadata extraction with multiple ID3 tag format fallbacks and normalization pipeline
- **Authentication Context**: NewAuthProvider uses deferred loading pattern to prevent initialization deadlocks
- **Authentication Consolidation**: Only `NewAuthProvider` exists - legacy `AuthContext` removed to prevent conflicts
- **Password Reset Architecture**: Complete flow with dedicated `/reset-password` page handling token validation
- **Pagination Requirements**: Supabase 1000-row limit with silent truncation - critical for large datasets
- **Role Security Design**: Roles stored separately from profiles to prevent privilege escalation attacks
- **Build Modes**: `npm run build:dev` creates development build with different configuration than standard build
- **Phase 4 Documentation**: Comprehensive setup guide at `docs/supabase-phase4-configuration.md` and `README-PHASE4-SETUP.md` for deployment
- **Phase 4 Services Architecture**: New singleton services (SpotifyHealthMonitorService, SpotifySecurityValidatorService) with getInstance() pattern
- **Token Vault Documentation**: Actual tokens encrypted in vault, database fields contain `***ENCRYPTED_IN_VAULT***` placeholders for security
- **Phase 4 Error Handling Documentation**: Centralized error handling with service-specific categorization and user-friendly messages
- **Security Validation Documentation**: Automated token exposure detection and vault integrity validation through dedicated services
- **Unified Spotify Auth Documentation**: Complete consolidation documented in `docs/spotify-authentication-migration-guide.md` and `docs/task-spotify-authentication-consolidation.md`
- **Spotify Integration Living Document**: Comprehensive technical reference at `docs/systems/spotify-integration.md` for unified authentication system
- **Validation Plan Documentation**: End-to-end testing strategy documented in `docs/spotify-auth-validation-plan.md` for production deployment